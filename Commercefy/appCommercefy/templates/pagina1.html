{% extends "basecliente.html" %}
{% load static %}

{% block title %}Productos · {{ site_name }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dashboardtrabajador.css' %}">
  <link rel="stylesheet" href="{% static 'css/pages/pagina1.css' %}">
  {% if edit_mode %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    .sortable-ghost { opacity: 0.4; background-color: #f8f9fa; border: 2px dashed #0d6efd; }
    .sortable-drag { cursor: grabbing; }
    .cursor-grab { cursor: grab; }
  </style>
  {% endif %}
{% endblock %}

{% block content %}
  {% if user.is_staff and not edit_mode %}
  <div class="container mt-3 text-end">
    <a href="?edit_mode=true" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i> Editar Página</a>
  </div>
  {% endif %}

  {% if edit_mode %}
  <div class="alert alert-info d-flex justify-content-between align-items-center container mt-3">
    <span><i class="bi bi-pencil-square"></i> Modo Edición Activado - Arrastra los bloques para reordenar</span>
    <a href="?edit_mode=false" class="btn btn-sm btn-outline-primary">Salir</a>
  </div>
  {% endif %}

  <div id="blocks-container">
  {% for block in blocks %}
    <div class="page-block position-relative {% if edit_mode %}border border-dashed border-primary p-2 mb-3 cursor-grab{% endif %}" data-id="{{ block.id }}">
      {{ block.content|json_script:block.id }}
      {% if edit_mode %}
        <div class="position-absolute top-0 end-0 p-2 z-3 bg-white shadow-sm rounded-bottom">
          <span class="badge bg-secondary">{{ block.get_block_type_display }}</span>
          <button class="btn btn-sm btn-light text-primary" title="Editar" onclick="openEditModal('{{ block.id }}', '{{ block.block_type }}', '{{ block.title|escapejs }}')"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-light text-danger" title="Eliminar"><i class="bi bi-trash"></i></button>
        </div>
      {% endif %}

      {% if block.block_type == 'hero' %}
        {% include 'components/hero_section.html' with title=block.title subtitle=block.content.subtitle button_text=block.content.button_text button_link=block.content.button_link %}

      {% elif block.block_type == 'offers_carousel' %}
        <!-- Carrusel de ofertas imperdibles -->
        {% include 'components/offers_carousel_section.html' with title=block.title products=ofertas_imperdibles %}

      {% elif block.block_type == 'product_list' %}
        <!-- Productos filtrables por categoría -->
        {% include 'components/product_filter_section.html' with use_card_wrapper=True title=block.title config=block.content %}

      {% elif block.block_type == 'info_cards' %}
        <!-- Tarjetas de información: Ayuda, Pedidos, Devoluciones, Tiendas -->
        {% include 'components/info_cards_section.html' with use_card_wrapper=False %}

      {% elif block.block_type == 'html' %}
        <div class="container mb-5">
          {{ block.content.html|safe }}
        </div>
      {% endif %}
    </div>
  {% endfor %}

  </div><!-- End blocks-container -->

  <!-- Edit Modal -->
  <div class="modal fade" id="editBlockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Bloque</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editBlockForm">
            <input type="hidden" id="editBlockId" name="block_id">
            <div class="mb-3">
              <label for="editBlockTitle" class="form-label">Título</label>
              <input type="text" class="form-control" id="editBlockTitle" name="title">
            </div>
            <div id="editBlockContentFields">
              <!-- Dynamic fields will be injected here -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="saveBlockChanges()">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  {% if edit_mode %}
  {{ default_cards|json_script:"default-cards-data" }}
  {% endif %}

  <script>
    {% if edit_mode %}
    const DEFAULT_INFO_CARDS = JSON.parse(document.getElementById('default-cards-data').textContent);
    
    document.addEventListener('DOMContentLoaded', function() {
        var el = document.getElementById('blocks-container');
        var sortable = Sortable.create(el, {
            animation: 150,
            draggable: ".page-block",
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                var order = sortable.toArray();
                fetch('{% url "reorder_page_blocks" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({order: order})
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status !== 'success') alert('Error al reordenar');
                });
            }
        });
    });
    {% endif %}

    function openEditModal(blockId, blockType, blockTitle) {
        document.getElementById('editBlockId').value = blockId;
        document.getElementById('editBlockTitle').value = blockTitle;
        
        const contentScript = document.getElementById(blockId);
        const content = contentScript ? JSON.parse(contentScript.textContent) : {};
        
        const contentFields = document.getElementById('editBlockContentFields');
        contentFields.innerHTML = ''; // Clear previous fields

        if (blockType === 'hero') {
            contentFields.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Subtítulo</label>
                    <input type="text" class="form-control" name="subtitle" value="${content.subtitle || ''}" placeholder="Descubre lo último...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Texto Botón</label>
                    <input type="text" class="form-control" name="button_text" value="${content.button_text || ''}" placeholder="Ver Ofertas">
                </div>
                <div class="mb-3">
                    <label class="form-label">Enlace Botón</label>
                    <input type="text" class="form-control" name="button_link" value="${content.button_link || ''}" placeholder="#ofertas">
                </div>
            `;
        } else if (blockType === 'info_cards') {
             let cards = content.cards || DEFAULT_INFO_CARDS;
             
             let cardsHTML = `
                <div class="mb-3">
                    <label class="form-label fw-bold">Tarjetas (Arrastra para reordenar)</label>
                    <div id="cards-list" class="list-group">
             `;
             
             cards.forEach((card, index) => {
                 cardsHTML += `
                    <div class="list-group-item d-flex align-items-center" data-index="${index}">
                        <i class="bi bi-grip-vertical me-2 text-muted handle cursor-grab"></i>
                        <div class="flex-grow-1 ms-2">
                            <div class="fw-bold">${card.title}</div>
                            <small class="text-muted">${card.subtitle}</small>
                        </div>
                        <input type="hidden" name="card_id_${index}" value="${card.id}">
                        <input type="hidden" name="card_icon_${index}" value="${card.icon}">
                        <input type="hidden" name="card_title_${index}" value="${card.title}">
                        <input type="hidden" name="card_subtitle_${index}" value="${card.subtitle}">
                        <input type="hidden" name="card_link_${index}" value="${card.link}">
                    </div>
                 `;
             });
             
             cardsHTML += `</div></div>`;
             contentFields.innerHTML = cardsHTML;
             
             setTimeout(() => {
                 new Sortable(document.getElementById('cards-list'), {
                     animation: 150,
                     handle: '.handle',
                     ghostClass: 'bg-light'
                 });
             }, 100);

        } else if (blockType === 'product_list') {
             // Subcomponents Reordering UI
             let layout = content.layout || ['category_filter', 'product_list', 'items_per_page_selector'];
             
             let subcomponentsHTML = `
                <div class="mb-3">
                    <label class="form-label fw-bold">Subcomponentes (Arrastra para reordenar)</label>
                    <div id="subcomponents-list" class="list-group">
             `;
             
             const labels = {
                 'category_filter': 'Filtro de Categorías',
                 'product_list': 'Lista de Productos',
                 'items_per_page_selector': 'Selector Paginación'
             };

             layout.forEach(comp => {
                 subcomponentsHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center" data-id="${comp}">
                        <span><i class="bi bi-grip-vertical me-2 text-muted"></i> ${labels[comp] || comp}</span>
                        ${comp !== 'product_list' ? `
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="show_${comp}" ${content['show_' + comp] !== false ? 'checked' : ''}>
                        </div>` : ''}
                    </div>
                 `;
             });
             
             subcomponentsHTML += `</div></div>
                <div class="mb-3">
                    <label class="form-label">Items por página (Default)</label>
                    <select class="form-select" name="default_items_per_page">
                        <option value="8" ${content.default_items_per_page == 8 ? 'selected' : ''}>8</option>
                        <option value="16" ${content.default_items_per_page == 16 ? 'selected' : ''}>16</option>
                        <option value="24" ${content.default_items_per_page == 24 ? 'selected' : ''}>24</option>
                    </select>
                </div>
             `;
             
             contentFields.innerHTML = subcomponentsHTML;
             
             // Initialize Sortable for subcomponents
             setTimeout(() => {
                 new Sortable(document.getElementById('subcomponents-list'), {
                     animation: 150,
                     handle: '.list-group-item',
                     ghostClass: 'bg-light'
                 });
             }, 100);
        }
        
        const modal = new bootstrap.Modal(document.getElementById('editBlockModal'));
        modal.show();
    }

    function saveBlockChanges() {
        const form = document.getElementById('editBlockForm');
        const blockId = document.getElementById('editBlockId').value;
        const title = document.getElementById('editBlockTitle').value;
        
        const formData = new FormData(form);
        const content = {};
        
        // Convert FormData to JSON object for content fields
        for (let [key, value] of formData.entries()) {
            if (key !== 'block_id' && key !== 'title' && !key.startsWith('show_')) {
                content[key] = value;
            }
        }
        
        // Handle subcomponents layout and visibility
        const subList = document.getElementById('subcomponents-list');
        const cardsList = document.getElementById('cards-list');
        
        if (subList) {
            const layout = [];
            subList.querySelectorAll('.list-group-item').forEach(item => {
                const compId = item.getAttribute('data-id');
                layout.push(compId);
                
                // Check visibility toggle if exists
                const toggle = item.querySelector('input[type="checkbox"]');
                if (toggle) {
                    content['show_' + compId] = toggle.checked;
                }
            });
            content['layout'] = layout;
        } else if (cardsList) {
            const cards = [];
            cardsList.querySelectorAll('.list-group-item').forEach(item => {
                const card = {
                    id: item.querySelector(`input[name^="card_id_"]`).value,
                    icon: item.querySelector(`input[name^="card_icon_"]`).value,
                    title: item.querySelector(`input[name^="card_title_"]`).value,
                    subtitle: item.querySelector(`input[name^="card_subtitle_"]`).value,
                    link: item.querySelector(`input[name^="card_link_"]`).value
                };
                cards.push(card);
            });
            content['cards'] = cards;
        } else {
            // Fallback for other blocks (checkboxes)
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                content[cb.name] = cb.checked;
            });
        }

        const payload = {
            block_id: blockId,
            title: title,
            content: content
        };

        fetch('{% url "update_page_block" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload(); // Reload to see changes
            } else {
                alert('Error al guardar: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión');
        });
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Lógica del carrusel de ofertas
      const scrollContainer = document.getElementById('offersCarousel');
      const prevBtn = document.getElementById('prevOffer');
      const nextBtn = document.getElementById('nextOffer');

      if(scrollContainer && prevBtn && nextBtn) {
        nextBtn.addEventListener('click', () => {
          const card = scrollContainer.querySelector('.card-product-carousel');
          if (card) {
            const gap = 16;
            const scrollAmount = card.offsetWidth + gap;
            
            // Vuelve al inicio si se llega al final
            if (scrollContainer.scrollLeft + scrollContainer.clientWidth >= scrollContainer.scrollWidth - 10) {
              scrollContainer.scrollTo({ left: 0, behavior: 'smooth' });
            } else {
              scrollContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
          }
        });
        
        prevBtn.addEventListener('click', () => {
          const card = scrollContainer.querySelector('.card-product-carousel');
          if (card) {
            const gap = 16;
            const scrollAmount = card.offsetWidth + gap;
            
            // Vuelve al final si se llega al inicio
            if (scrollContainer.scrollLeft <= 10) {
              scrollContainer.scrollTo({ left: scrollContainer.scrollWidth, behavior: 'smooth' });
            } else {
              scrollContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            }
          }
        });
      }

      // Filtrado AJAX y paginación
      const productContainer = document.getElementById('product-list-container');
      const filterChips = document.querySelectorAll('.filter-chip');
      const itemsSelect = document.getElementById('items');
      const itemsForm = document.getElementById('itemsPerPageForm');

      // Resuelve conflictos de z-index en modales en dispositivos móviles
      function moveModalsToBody(container) {
        if (!container) return;
        const modals = container.querySelectorAll('.modal');
        modals.forEach(modal => {
          document.body.appendChild(modal);
          if (container.id === 'product-list-container') {
            modal.classList.add('list-modal');
          }
        });
      }

      // Mueve modales del contenido estático
      moveModalsToBody(document.getElementById('offersCarousel'));
      moveModalsToBody(productContainer);

      function updateFormInputs(url) {
          const urlObj = new URL(url, window.location.origin);
          const params = urlObj.searchParams;
          
          if (itemsForm) {
              const catInput = itemsForm.querySelector('input[name="category"]');
              if (catInput) catInput.value = params.get('category') || '';
              
              const sortInput = itemsForm.querySelector('input[name="sort"]');
              if (sortInput) sortInput.value = params.get('sort') || '';
              
              const itemsSelect = document.getElementById('items');
              if (itemsSelect) {
                  const itemsVal = params.get('items');
                  if (itemsVal) itemsSelect.value = itemsVal;
              }
          }
      }

      function fetchProducts(url) {
        productContainer.style.opacity = '0.5';
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Elimina modales antiguos
            document.querySelectorAll('.modal.list-modal').forEach(el => el.remove());

            productContainer.innerHTML = html;
            productContainer.style.opacity = '1';
            
            // Mueve modales nuevos
            moveModalsToBody(productContainer);

            history.pushState(null, '', url);
            updateFormInputs(url);
            attachPaginationListeners();
        })
        .catch(error => {
            console.error('Error:', error);
            productContainer.style.opacity = '1';
        });
      }

      function attachPaginationListeners() {
        const paginationLinks = document.querySelectorAll('.pagination .ajax-link');
        paginationLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                fetchProducts(this.href);
                document.getElementById('imperdibles').scrollIntoView({ behavior: 'smooth' });
            });
        });
      }

      filterChips.forEach(chip => {
        chip.addEventListener('click', function(e) {
            e.preventDefault();
            
            filterChips.forEach(c => {
                c.classList.remove('active', 'btn-primary');
                c.classList.add('btn-outline-primary');
            });
            this.classList.add('active', 'btn-primary');
            this.classList.remove('btn-outline-primary');

            // Construye URL preservando el estado actual
            const category = this.getAttribute('data-category');
            const items = document.getElementById('items').value;
            const sortInput = document.querySelector('input[name="sort"]');
            const sort = sortInput ? sortInput.value : '';

            const params = new URLSearchParams();
            if (category && category !== 'all') params.set('category', category);
            else params.set('category', 'all');
            
            if (items) params.set('items', items);
            if (sort) params.set('sort', sort);

            const url = '?' + params.toString();
            fetchProducts(url);
        });
      });

      if (itemsSelect) {
          itemsSelect.addEventListener('change', function() {
              const formData = new FormData(itemsForm);
              const params = new URLSearchParams(formData);
              const url = '?' + params.toString();
              fetchProducts(url);
          });
      }

      attachPaginationListeners();

      window.addEventListener('popstate', function() {
           location.reload();
      });
    });
  </script>
{% endblock %}
